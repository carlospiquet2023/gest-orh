<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix Pro • Escala e Presença Premium</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #0ea5e9;
        }
        body { font-family: 'Plus Jakarta Sans', 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        
        /* Scrollbar Premium */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Tooltip Refinado (Substituto da "Tarja Preta") */
        #custom-tooltip {
            position: fixed;
            background-color: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(4px);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            pointer-events: none;
            z-index: 9999;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transition: opacity 0.2s cubic-bezier(0.16, 1, 0.3, 1), transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            white-space: nowrap;
            border: 1px solid rgba(255,255,255,0.1);
        }
        #custom-tooltip.visible { opacity: 1; transform: translateY(0) scale(1); }

        /* Animações e Efeitos */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .hover-lift { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.01); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

        /* --- CSS DE IMPRESSÃO OTIMIZADO (CORREÇÃO DE REPETIÇÃO) --- */
        @media print {
            @page { size: landscape; margin: 4mm; }
            
            /* Reset Total para Impressão */
            html, body, #matrix-wrapper, #matrix-container, main, .flex { 
                display: block !important; 
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
                position: static !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }
            
            body { zoom: 65%; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            
            /* Ocultar elementos de UI */
            .no-print, nav, aside, #quick-stats, #loading-overlay, .fixed, button, #toast-container, #custom-tooltip { display: none !important; }
            .print-only { display: block !important; }
            
            /* Correção Crítica do Cabeçalho Repetido */
            /* Removemos sticky e garantimos que o thead padrão do navegador assuma, mas sem duplicatas de JS */
            .sticky-col, .sticky-header, .sticky-corner { 
                position: static !important; 
                border: 1px solid #e2e8f0 !important;
                box-shadow: none !important;
            }
            
            #print-table-clone { display: none !important; } /* Garante que clones manuais sumam */

            table { 
                width: 100% !important; 
                border-collapse: collapse !important; 
                font-size: 10px !important; 
                page-break-inside: auto;
                table-layout: auto !important; /* Importante para evitar quebras estranhas */
            }
            
            thead { 
                display: table-header-group !important; /* Padrão correto para repetir 1x por página */
                break-inside: avoid;
            }
            
            tr { page-break-inside: avoid; page-break-after: auto; }
            td, th { border: 1px solid #94a3b8 !important; padding: 4px !important; }
            
            /* Estilo Limpo de Impressão */
            th { background-color: #f1f5f9 !important; color: #0f172a !important; font-weight: 800 !important; }
            .bg-ho { background-color: #f3f4f6 !important; color: #64748b !important; } 
            .bg-office { background-color: #fff !important; color: #000 !important; font-weight: 900; }
            
            /* Footer de Assinatura */
            #print-footer { 
                display: flex !important; 
                justify-content: space-between; 
                margin-top: 30px; 
                padding-top: 10px; 
                page-break-inside: avoid; 
            }
            .signature-line { border-top: 1px solid #000; width: 250px; text-align: center; font-size: 10px; font-weight: bold; margin-top: 20px; }
        }
        
        .print-only { display: none; }
        .sticky-col { position: sticky; left: 0; background: white; z-index: 10; border-right: 1px solid #e2e8f0; }
        .sticky-header { position: sticky; top: 0; z-index: 20; background: #f8fafc; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .sticky-corner { position: sticky; top: 0; left: 0; z-index: 30; background: #f8fafc; border-right: 1px solid #e2e8f0; }

        .drag-target-active { background-color: #e0e7ff !important; outline: 2px dashed #6366f1; }
        .draggable-source { cursor: grab; }
        .draggable-source:active { cursor: grabbing; }

        /* Cores de Status Refinadas */
        .status-P { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; } 
        .status-F { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; } 
        .status-J { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; } 
        .status-A { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; } 
        .status-S { background-color: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; } 
        .status-N { background-color: #f1f5f9; color: #64748b; }
    </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800 overflow-hidden">

    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>
    <div id="custom-tooltip"></div>

    <!-- Modal de Confirmação -->
    <div id="confirm-modal" class="fixed inset-0 bg-slate-900/40 z-[110] hidden flex items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm animate-fade-in border border-slate-100">
            <h3 class="text-lg font-bold text-slate-800 mb-2" id="confirm-title">Confirmar</h3>
            <p class="text-sm text-slate-600 mb-6 leading-relaxed" id="confirm-message"></p>
            <div class="flex justify-end gap-3">
                <button id="confirm-cancel" class="px-5 py-2.5 text-sm font-semibold text-slate-500 hover:bg-slate-50 rounded-xl transition-colors">Cancelar</button>
                <button id="confirm-ok" class="px-5 py-2.5 text-sm font-semibold text-white bg-indigo-600 hover:bg-indigo-700 rounded-xl shadow-lg shadow-indigo-200 transition-all">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Seleção de Datas -->
    <div id="date-selection-modal" class="fixed inset-0 bg-slate-900/50 z-[100] hidden flex items-center justify-center backdrop-blur-sm no-print">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-3xl mx-4 flex flex-col max-h-[85vh] overflow-hidden animate-fade-in border border-slate-200">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0">
                <div>
                    <h3 class="font-bold text-slate-800 flex items-center gap-2 text-lg"><div class="p-2 bg-indigo-50 rounded-lg text-indigo-600"><i data-lucide="calendar-check" class="w-5 h-5"></i></div> Datas da Escala</h3>
                    <p class="text-sm text-slate-500 mt-1">Selecione os dias úteis para gerar a escala automática.</p>
                </div>
                <button onclick="closeModal('date-selection-modal')" class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-50 rounded-full transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="px-6 py-3 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Dias do Mês</span>
                <button onclick="toggleAllDatesSelection()" class="text-xs font-bold text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 px-3 py-1.5 rounded-lg transition-colors">Selecionar Todos</button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-3 bg-slate-50/50" id="dates-checkbox-list"></div>
            <div class="p-6 bg-white border-t border-slate-100 flex gap-3">
                <button onclick="confirmGenerateWithDates()" class="w-full py-3.5 bg-indigo-600 text-white rounded-xl text-sm font-bold shadow-xl shadow-indigo-100 hover:shadow-indigo-200 hover:bg-indigo-700 hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="sparkles" class="w-4 h-4"></i> GERAR ESCALA INTELIGENTE
                </button>
            </div>
        </div>
    </div>

    <!-- Navbar Premium -->
    <nav class="bg-white border-b border-slate-200/80 px-4 md:px-6 py-3 no-print sticky top-0 z-50 shadow-sm/50 backdrop-blur-md bg-white/90">
        <div class="max-w-[1920px] mx-auto flex flex-col xl:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-6 w-full xl:w-auto">
                <div class="flex items-center gap-3 select-none">
                    <div class="bg-gradient-to-br from-indigo-600 to-violet-600 p-2.5 rounded-xl shadow-lg shadow-indigo-200">
                        <i data-lucide="layers" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold tracking-tight text-slate-900 leading-none font-display">Matrix<span class="text-indigo-600">Pro</span></h1>
                        <div class="flex gap-2 text-[10px] text-slate-400 mt-1 uppercase font-bold tracking-wider">
                            <span id="header-local">Gestão</span>
                            <span id="header-sep" class="hidden">•</span>
                            <span id="header-unidade">Inteligente</span>
                        </div>
                    </div>
                </div>

                <div class="flex bg-slate-100/80 p-1.5 rounded-xl border border-slate-200 ml-4">
                    <button onclick="setSystemMode('schedule')" id="btn-mode-schedule" class="px-5 py-2 rounded-lg text-xs font-bold transition-all shadow-sm bg-white text-indigo-700">ESCALA</button>
                    <button onclick="setSystemMode('attendance')" id="btn-mode-attendance" class="px-5 py-2 rounded-lg text-xs font-bold text-slate-500 hover:text-slate-700 transition-all">PRESENÇA</button>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-3 items-center justify-end w-full xl:w-auto">
                <div class="flex items-center bg-white border border-slate-200 rounded-xl shadow-sm h-10">
                    <button onclick="changeMonth(-1)" class="px-3 h-full text-slate-400 hover:text-indigo-600 hover:bg-slate-50 rounded-l-xl transition-colors"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    <span id="current-month-display" class="px-4 font-bold text-sm min-w-[140px] text-center capitalize text-slate-700 select-none"></span>
                    <button onclick="changeMonth(1)" class="px-3 h-full text-slate-400 hover:text-indigo-600 hover:bg-slate-50 rounded-r-xl transition-colors"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>

                <div class="h-8 w-px bg-slate-200 mx-1"></div>

                <div class="flex items-center gap-2">
                    <button onclick="openContextModal()" class="w-10 h-10 flex items-center justify-center bg-white border border-slate-200 text-slate-600 rounded-xl hover:border-indigo-300 hover:text-indigo-600 hover:bg-indigo-50 transition-all hover-lift" data-tooltip="Local e Agendamento"><i data-lucide="map-pin" class="w-4 h-4"></i></button>
                    <button onclick="openVacationModal()" class="w-10 h-10 flex items-center justify-center bg-white border border-slate-200 text-slate-600 rounded-xl hover:border-amber-300 hover:text-amber-600 hover:bg-amber-50 transition-all hover-lift" data-tooltip="Férias"><i data-lucide="plane" class="w-4 h-4"></i></button>
                    <button onclick="openHolidayModal()" class="w-10 h-10 flex items-center justify-center bg-white border border-slate-200 text-slate-600 rounded-xl hover:border-rose-300 hover:text-rose-600 hover:bg-rose-50 transition-all hover-lift" data-tooltip="Feriados"><i data-lucide="calendar-off" class="w-4 h-4"></i></button>
                    <button onclick="openReportsModal()" class="w-10 h-10 flex items-center justify-center bg-teal-50 border border-teal-200 text-teal-700 rounded-xl hover:bg-teal-100 transition-all hover-lift" data-tooltip="Relatórios"><i data-lucide="bar-chart-3" class="w-4 h-4"></i></button>
                    
                    <div id="schedule-controls" class="flex items-center gap-2 ml-2 bg-slate-50 p-1 rounded-xl border border-slate-200">
                        <span class="text-[10px] font-bold text-slate-400 pl-2 uppercase">Dias HO:</span>
                        <input type="number" id="global-ho-days" value="2" min="0" max="5" class="w-10 p-1 text-center text-sm font-bold bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-indigo-600">
                    </div>

                    <button onclick="handleGenerateTrigger()" class="ml-2 flex items-center gap-2 px-6 py-2.5 bg-slate-900 text-white rounded-xl font-bold text-sm shadow-lg shadow-slate-200 hover:bg-indigo-600 hover:shadow-indigo-200 transition-all transform active:scale-95">
                        <i data-lucide="sparkles" class="w-4 h-4"></i> <span class="hidden sm:inline">GERAR</span>
                    </button>
                </div>

                <div class="h-8 w-px bg-slate-200 mx-1"></div>
                
                <button id="btn-portal" onclick="downloadPortalFile()" class="w-10 h-10 flex items-center justify-center bg-emerald-600 text-white rounded-xl shadow-lg shadow-emerald-200 hover:bg-emerald-500 hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none" disabled data-tooltip="Baixar Portal App"><i data-lucide="smartphone" class="w-4 h-4"></i></button>
                <button onclick="handleReset()" class="w-10 h-10 flex items-center justify-center text-slate-300 hover:text-rose-500 hover:bg-rose-50 rounded-xl transition-all" data-tooltip="Limpar Sistema"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </div>
        </div>
    </nav>

    <!-- Content Layout -->
    <div class="max-w-[1920px] mx-auto flex flex-col lg:flex-row h-[calc(100vh-73px)]">
        <!-- Sidebar -->
        <aside class="w-full lg:w-80 bg-white border-r border-slate-200 flex flex-col no-print z-10 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
            <div class="p-5 border-b border-slate-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-slate-800 text-xs uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="users" class="w-3.5 h-3.5 text-indigo-500"></i> <span id="sidebar-label">Equipe</span> <span class="px-2 py-0.5 bg-slate-100 text-slate-500 rounded-full text-[10px]" id="emp-count">0</span>
                    </h2>
                    <button onclick="handleClearEmployees()" class="text-[10px] font-bold text-slate-400 hover:text-rose-500 transition-colors uppercase tracking-wider">Limpar Lista</button>
                </div>
                <div class="space-y-3">
                    <div class="relative group">
                        <input type="text" id="new-emp-name" placeholder="Adicionar nome..." class="w-full pl-4 pr-11 py-3 bg-slate-50 border-transparent focus:bg-white border focus:border-indigo-500 rounded-xl text-sm transition-all outline-none" onkeypress="if(event.key==='Enter') addEmployee()">
                        <button onclick="addEmployee()" class="absolute right-2 top-2 p-1.5 bg-white text-indigo-600 rounded-lg shadow-sm border border-slate-100 hover:bg-indigo-50 transition-colors"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    
                    <div class="relative">
                        <input type="text" id="emp-search" placeholder="Buscar..." class="w-full pl-9 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-xs outline-none focus:border-indigo-400 focus:ring-2 focus:ring-indigo-50 transition-all" oninput="renderEmployeeList()">
                        <i data-lucide="search" class="w-3.5 h-3.5 absolute left-3 top-2.5 text-slate-400"></i>
                    </div>

                    <div class="grid grid-cols-2 gap-2 pt-2">
                        <input type="file" id="file-input" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleFileUpload(this)">
                        <button onclick="document.getElementById('file-input').click()" class="py-2.5 border border-dashed border-slate-300 rounded-xl text-[10px] font-bold text-slate-500 hover:border-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 transition-all flex items-center justify-center gap-2"><i data-lucide="upload" class="w-3.5 h-3.5"></i> IMPORTAR</button>
                        <button onclick="downloadTemplate()" class="py-2.5 border border-dashed border-slate-300 rounded-xl text-[10px] font-bold text-slate-500 hover:border-emerald-400 hover:text-emerald-600 hover:bg-emerald-50 transition-all flex items-center justify-center gap-2"><i data-lucide="download" class="w-3.5 h-3.5"></i> MODELO</button>
                    </div>
                </div>
            </div>
            <div id="employee-list" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar bg-slate-50/30"></div>
            <div class="p-4 bg-white border-t border-slate-100 text-[10px] text-slate-400 text-center font-medium flex justify-between items-center">
                <span>Matrix Pro v4.5</span>
                <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
            </div>
        </aside>

        <!-- Main View -->
        <main class="flex-1 flex flex-col overflow-hidden bg-slate-50/50 relative">
            <!-- Stats Dashboard -->
            <div id="quick-stats" class="px-8 pt-8 pb-4 grid grid-cols-4 gap-6 no-print hidden lg:grid">
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow flex items-center gap-4">
                    <div class="p-3 bg-indigo-50 rounded-xl text-indigo-600"><i data-lucide="users" class="w-5 h-5"></i></div>
                    <div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Total Equipe</p><p class="text-xl font-black text-slate-800" id="stat-team-count">0</p></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow flex items-center gap-4">
                    <div class="p-3 bg-emerald-50 rounded-xl text-emerald-600"><i data-lucide="briefcase" class="w-5 h-5"></i></div>
                    <div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Presencial Hoje</p><p class="text-xl font-black text-slate-800" id="stat-today-pres">0</p></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow flex items-center gap-4">
                    <div class="p-3 bg-amber-50 rounded-xl text-amber-600"><i data-lucide="palmtree" class="w-5 h-5"></i></div>
                    <div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Em Férias</p><p class="text-xl font-black text-slate-800" id="stat-vac-count">0</p></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow flex items-center gap-4">
                    <div class="p-3 bg-rose-50 rounded-xl text-rose-600"><i data-lucide="alert-circle" class="w-5 h-5"></i></div>
                    <div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Alertas Mês</p><p class="text-xl font-black text-slate-800" id="stat-month-fails">0</p></div>
                </div>
            </div>

            <div id="matrix-wrapper" class="flex-1 overflow-auto custom-scrollbar p-6 lg:px-8 pb-20">
                <!-- Header de Impressão -->
                <div class="print-only p-4 mb-4 border-b-2 border-slate-800">
                    <div class="flex justify-between items-end">
                        <div>
                            <h1 class="text-3xl font-black uppercase tracking-tight text-slate-900" id="print-header-title">Escala Mensal</h1>
                            <p id="print-month-title" class="text-xl font-bold text-slate-600 capitalize"></p>
                        </div>
                        <div class="text-right">
                             <div class="text-xs font-bold text-slate-400 uppercase">Documento Interno</div>
                             <div id="print-date-generated" class="text-xs text-slate-900"></div>
                        </div>
                    </div>
                    <div id="print-context" class="flex gap-8 text-xs font-bold mt-4 pt-2 border-t border-slate-200 uppercase text-slate-700"></div>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="h-full flex flex-col items-center justify-center text-slate-300 select-none pb-20">
                    <div class="w-24 h-24 bg-white rounded-3xl flex items-center justify-center shadow-[0_20px_40px_-10px_rgba(0,0,0,0.05)] border border-slate-100 mb-6">
                        <i data-lucide="calendar-plus" class="w-10 h-10 text-indigo-100"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-700 mb-2">Comece sua Escala</h3>
                    <p class="text-sm text-slate-400 max-w-xs text-center">Importe uma planilha ou adicione colaboradores manualmente para gerar a matriz.</p>
                </div>

                <!-- Matrix Table -->
                <div id="matrix-container" class="hidden bg-white shadow-xl shadow-slate-200/50 rounded-2xl border border-slate-200 w-max min-w-full overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead id="matrix-head" class="text-[10px] uppercase tracking-wider bg-slate-50/80 text-slate-500 font-bold backdrop-blur-sm"></thead>
                        <tbody id="matrix-body" class="text-sm text-slate-600 divide-y divide-slate-100"></tbody>
                    </table>
                </div>

                <!-- Footer Impressão -->
                <div id="print-footer" class="print-only hidden">
                    <div class="flex gap-20 justify-center w-full">
                        <div class="signature-line">Gestor Responsável</div>
                        <div class="signature-line">Recursos Humanos</div>
                    </div>
                </div>
            </div>

            <!-- Botões Flutuantes -->
            <div class="fixed bottom-8 right-8 flex flex-col gap-3 z-50 no-print">
                <button onclick="exportToExcel()" class="bg-emerald-600 text-white p-4 rounded-2xl shadow-xl shadow-emerald-200 hover:bg-emerald-500 hover:scale-105 hover:-translate-y-1 transition-all group" data-tooltip="Exportar Excel">
                    <i data-lucide="file-spreadsheet" class="w-6 h-6 group-hover:rotate-12 transition-transform"></i>
                </button>
                <button onclick="window.print()" class="bg-slate-900 text-white p-4 rounded-2xl shadow-xl shadow-slate-300 hover:bg-slate-800 hover:scale-105 hover:-translate-y-1 transition-all group" data-tooltip="Imprimir">
                    <i data-lucide="printer" class="w-6 h-6 group-hover:scale-110 transition-transform"></i>
                </button>
                <!-- Botão Python removido conforme solicitado -->
            </div>
        </main>
    </div>

    <!-- MODAL: REGISTRO DE PRESENÇA -->
    <div id="attendance-modal" class="fixed inset-0 bg-slate-900/60 z-[120] hidden flex items-center justify-center backdrop-blur-sm no-print">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md mx-4 overflow-hidden animate-fade-in border border-slate-100">
            <div class="p-6 border-b flex justify-between items-center bg-indigo-50/50">
                <div>
                    <h3 class="font-bold text-indigo-950 text-lg" id="att-modal-title">Detalhes</h3>
                    <p class="text-xs text-indigo-500 font-bold uppercase tracking-wider mt-0.5" id="att-modal-subtitle"></p>
                </div>
                <button onclick="closeModal('attendance-modal')" class="text-indigo-300 hover:text-indigo-600 transition-colors bg-white rounded-full p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-5">
                <div class="space-y-3">
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Informações</label>
                    <input type="text" id="att-subject" placeholder="Atividade / Matéria" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="time" id="att-time-start" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm text-center">
                        <input type="time" id="att-time-end" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm text-center">
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Status</label>
                    <div class="grid grid-cols-2 gap-3" id="att-status-group">
                        <label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-emerald-50 transition-all has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-50 has-[:checked]:shadow-sm">
                            <input type="radio" name="att-status" value="P" class="w-4 h-4 text-emerald-600 accent-emerald-600"><span class="text-sm font-bold text-slate-700">Presença</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-rose-50 transition-all has-[:checked]:border-rose-500 has-[:checked]:bg-rose-50 has-[:checked]:shadow-sm">
                            <input type="radio" name="att-status" value="F" class="w-4 h-4 text-rose-600 accent-rose-600"><span class="text-sm font-bold text-slate-700">Falta</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-blue-50 transition-all has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 has-[:checked]:shadow-sm col-span-2">
                            <input type="radio" name="att-status" value="J" class="w-4 h-4 text-blue-600 accent-blue-600" onchange="toggleJustification(true)"><span class="text-sm font-bold text-slate-700">Falta Justificada</span>
                        </label>
                    </div>
                </div>

                <div id="justification-fields" class="hidden animate-fade-in">
                    <textarea id="att-obs" placeholder="Motivo da justificativa..." class="w-full p-3 border border-slate-200 bg-slate-50 rounded-xl text-sm h-24 focus:ring-2 focus:ring-blue-500 outline-none resize-none"></textarea>
                </div>
            </div>
            <div class="p-5 bg-slate-50 border-t flex justify-end gap-3">
                <button onclick="closeModal('attendance-modal')" class="px-5 py-2.5 text-sm font-bold text-slate-500 hover:text-slate-800 transition-colors">Cancelar</button>
                <button onclick="saveAttendance()" class="px-8 py-2.5 bg-indigo-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 transform active:scale-95 transition-all">SALVAR</button>
            </div>
        </div>
    </div>

    <!-- Modal Relatórios -->
    <div id="reports-modal" class="fixed inset-0 bg-slate-900/60 z-[120] hidden flex items-center justify-center backdrop-blur-sm no-print">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-4xl mx-4 flex flex-col max-h-[90vh] overflow-hidden animate-fade-in">
            <div class="p-6 border-b flex justify-between items-center bg-teal-50/50">
                <div>
                    <h3 class="font-bold text-teal-900 flex items-center gap-2 text-lg"><i data-lucide="pie-chart" class="w-5 h-5 text-teal-600"></i> Relatório de Performance</h3>
                    <p class="text-xs text-teal-600 uppercase font-bold tracking-widest mt-1" id="rep-month-label"></p>
                </div>
                <button onclick="closeModal('reports-modal')" class="text-teal-400 hover:text-teal-600 bg-white p-1 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="p-6 bg-slate-50/50 border-b space-y-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100"><p class="text-[10px] text-slate-400 font-bold uppercase mb-2">Presenças</p><p class="text-3xl font-black text-emerald-600" id="rep-total-presencas">0</p></div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100"><p class="text-[10px] text-slate-400 font-bold uppercase mb-2">Faltas</p><p class="text-3xl font-black text-rose-600" id="rep-total-faltas">0</p></div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100"><p class="text-[10px] text-slate-400 font-bold uppercase mb-2">Justificadas</p><p class="text-3xl font-black text-blue-600" id="rep-total-just">0</p></div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100"><p class="text-[10px] text-slate-400 font-bold uppercase mb-2">Frequência</p><p class="text-3xl font-black text-indigo-600" id="rep-freq-geral">0%</p></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 w-full h-64">
                    <canvas id="attendance-chart"></canvas>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar p-0">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-500 text-[10px] font-bold uppercase sticky top-0 z-10">
                        <tr><th class="p-4 border-b">Colaborador</th><th class="p-4 border-b text-center">P</th><th class="p-4 border-b text-center">F</th><th class="p-4 border-b text-center">J</th><th class="p-4 border-b">Aproveitamento</th></tr>
                    </thead>
                    <tbody id="reports-body" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Contexto -->
    <div id="context-modal" class="fixed inset-0 bg-slate-900/60 z-[100] hidden flex items-center justify-center backdrop-blur-sm no-print">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl mx-4 flex flex-col animate-fade-in border border-slate-100">
            <div class="p-6 border-b flex justify-between items-center">
                <div><h3 class="font-bold text-slate-800 text-lg">Configurar Local</h3><p class="text-xs text-slate-500">Defina os parâmetros do cabeçalho da escala.</p></div>
                <button onclick="closeModal('context-modal')" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-8 space-y-6">
                <div class="space-y-4">
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Nome do Local / Empresa</label><input type="text" id="ctx-local" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-500 bg-slate-50 focus:bg-white transition-all"></div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Unidade / Departamento</label><input type="text" id="ctx-unidade" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-500 bg-slate-50 focus:bg-white transition-all"></div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Sala / Setor (Opcional)</label><input type="text" id="ctx-sala" class="w-full p-3.5 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-500 bg-slate-50 focus:bg-white transition-all"></div>
                </div>
            </div>
            <div class="p-6 bg-slate-50 border-t rounded-b-3xl flex justify-end">
                <button onclick="saveContext()" class="bg-indigo-600 text-white px-8 py-3 rounded-xl text-sm font-bold shadow-lg hover:bg-indigo-700 hover:-translate-y-0.5 transition-all">SALVAR ALTERAÇÕES</button>
            </div>
        </div>
    </div>

    <!-- Modais Auxiliares (Férias/Feriados) -->
    <div id="vacation-modal" class="fixed inset-0 bg-slate-900/60 z-[100] hidden flex items-center justify-center backdrop-blur-sm no-print"><div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg mx-4 flex flex-col max-h-[85vh] overflow-hidden"><div class="p-6 border-b flex justify-between items-center bg-amber-50/50"><h3 class="text-lg font-bold text-amber-900 flex items-center gap-2"><i data-lucide="plane" class="w-5 h-5 text-amber-600"></i> Registrar Férias</h3><button onclick="closeModal('vacation-modal')" class="text-amber-400 hover:text-amber-700"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-6 border-b space-y-4 bg-white"><div><label class="block text-xs font-bold text-slate-400 mb-1 uppercase">Colaborador</label><select id="vacation-emp-select" class="w-full p-3 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-amber-500 outline-none bg-slate-50"></select></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-400 mb-1 uppercase">Início</label><input type="date" id="vacation-start" class="w-full p-3 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-amber-500 bg-slate-50"></div><div><label class="block text-xs font-bold text-slate-400 mb-1 uppercase">Fim</label><input type="date" id="vacation-end" class="w-full p-3 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-amber-500 bg-slate-50"></div></div><button onclick="addVacation()" class="w-full py-3 bg-amber-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-amber-100 flex justify-center gap-2 hover:bg-amber-600 transition-all">ADICIONAR PERÍODO</button></div><div class="flex-1 overflow-y-auto p-4 custom-scrollbar bg-slate-50" id="vacation-list"></div></div></div>
    <div id="holiday-modal" class="fixed inset-0 bg-slate-900/60 z-[100] hidden flex items-center justify-center backdrop-blur-sm no-print"><div class="bg-white rounded-3xl shadow-2xl w-full max-w-md mx-4 flex flex-col max-h-[85vh] overflow-hidden"><div class="p-6 border-b flex justify-between items-center bg-rose-50/50"><h3 class="text-lg font-bold text-rose-900 flex items-center gap-2"><i data-lucide="calendar-off" class="w-5 h-5 text-rose-600"></i> Feriados</h3><button onclick="closeModal('holiday-modal')" class="text-rose-400 hover:text-rose-700"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-6 border-b space-y-4 bg-white"><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Data</label><input type="date" id="holiday-date" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50"></div><div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Tipo</label><select id="holiday-type" class="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50"><option value="FERIADO">Feriado</option><option value="FACULTATIVO">Facultativo</option></select></div></div><button onclick="addHoliday()" class="w-full py-3 bg-rose-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-rose-100 flex justify-center gap-2 hover:bg-rose-600 transition-all">ADICIONAR DATA</button></div><div class="flex-1 overflow-y-auto p-4 custom-scrollbar bg-slate-50" id="holiday-list"></div></div></div>

    <script>
        // === ESTADO GLOBAL ===
        let currentDate = new Date();
        let employees = []; 
        let schedule = {}; 
        let attendance = {}; 
        let holidays = {}; 
        let isScheduleGenerated = false;
        let globalHODays = 2; 
        let vacations = {}; 
        let currentMode = 'schedule'; 
        let context = { local: '', unidade: '', sala: '', calendar: [] }; 
        let selectedDays = []; 
        let dayMetadata = {}; 
        let currentAttKey = null;
        let attendanceChart = null; 

        const hoPairs = [[0, 2], [1, 3], [2, 4], [3, 0], [4, 1], [0, 3], [1, 4]];

        // === PERSISTÊNCIA ===
        function saveData() {
            const data = { employees, schedule, isScheduleGenerated, globalHODays, vacations, attendance, holidays, context, selectedDays, currentMode, dayMetadata };
            localStorage.setItem('matrix_pro_premium_data', JSON.stringify(data));
            updateDashboard();
        }

        function loadData() {
            const saved = localStorage.getItem('matrix_pro_premium_data');
            if (saved) {
                try {
                    const p = JSON.parse(saved);
                    if(p.employees) employees = p.employees;
                    if(p.schedule) schedule = p.schedule;
                    if(p.attendance) attendance = p.attendance;
                    if(p.holidays) holidays = p.holidays;
                    if(p.isScheduleGenerated !== undefined) isScheduleGenerated = p.isScheduleGenerated;
                    if(p.globalHODays) globalHODays = p.globalHODays;
                    if(p.vacations) vacations = p.vacations;
                    if(p.currentMode) currentMode = p.currentMode;
                    if(p.context) context = p.context;
                    if(p.selectedDays) selectedDays = p.selectedDays;
                    if(p.dayMetadata) dayMetadata = p.dayMetadata;

                    setSystemMode(currentMode, false);
                    document.getElementById('global-ho-days').value = globalHODays;
                } catch(e) { console.error("Erro ao carregar dados", e); }
            }
        }

        // === TOOLTIPS REFINADOS ===
        function initTooltips() {
            const tooltip = document.getElementById('custom-tooltip');
            document.querySelectorAll('[data-tooltip]').forEach(el => {
                el.addEventListener('mouseenter', e => {
                    const text = el.getAttribute('data-tooltip');
                    if(!text) return;
                    tooltip.textContent = text;
                    tooltip.classList.add('visible');
                    positionTooltip(e, tooltip);
                });
                el.addEventListener('mousemove', e => positionTooltip(e, tooltip));
                el.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('visible');
                });
            });
        }

        function positionTooltip(e, tooltip) {
            const x = e.clientX;
            const y = e.clientY;
            const offset = 15;
            
            // Lógica para não sair da tela
            let left = x + offset;
            let top = y + offset;
            
            if (left + tooltip.offsetWidth > window.innerWidth) {
                left = x - tooltip.offsetWidth - offset;
            }
            if (top + tooltip.offsetHeight > window.innerHeight) {
                top = y - tooltip.offsetHeight - offset;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        // === DASHBOARD E BUSCA ===
        function updateDashboard() {
            document.getElementById('stat-team-count').innerText = employees.length;
            
            const today = new Date();
            const todayKey = `${today.getFullYear()}-${today.getMonth()}-${today.getDate()}`;
            let todayPres = 0;
            let monthFails = 0;
            let vacCount = 0;

            employees.forEach(emp => {
                const attToday = attendance[todayKey + '-' + emp.id]?.status || 'P';
                if(['P','A','S'].includes(attToday)) todayPres++;
                if(isEmployeeOnVacation(emp.id, today)) vacCount++;
                selectedDays.forEach(d => {
                    const k = `${currentDate.getFullYear()}-${currentDate.getMonth()}-${d}`;
                    if(attendance[k + '-' + emp.id]?.status === 'F') monthFails++;
                });
            });

            document.getElementById('stat-today-pres').innerText = todayPres;
            document.getElementById('stat-vac-count').innerText = vacCount;
            document.getElementById('stat-month-fails').innerText = monthFails;
        }

        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const styles = { 
                success: 'bg-white border-l-4 border-emerald-500 text-slate-800', 
                error: 'bg-white border-l-4 border-rose-500 text-slate-800', 
                info: 'bg-white border-l-4 border-indigo-500 text-slate-800' 
            };
            const icons = { success: 'check-circle', error: 'alert-circle', info: 'info' };
            const iconColors = { success: 'text-emerald-500', error: 'text-rose-500', info: 'text-indigo-500' };

            toast.className = `${styles[type]} px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 animate-fade-in min-w-[300px] border border-slate-100`;
            toast.innerHTML = `<i data-lucide="${icons[type]}" class="w-5 h-5 ${iconColors[type]}"></i><span class="text-sm font-semibold">${msg}</span>`;
            
            container.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => { 
                toast.style.opacity = '0'; 
                toast.style.transform = 'translateY(-10px)';
                setTimeout(() => toast.remove(), 300); 
            }, 3000);
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }

        function updateMonthDisplay() {
            const txt = currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            document.getElementById('current-month-display').textContent = txt;
            document.getElementById('print-month-title').textContent = txt;
            document.getElementById('rep-month-label').textContent = txt;
            document.getElementById('print-date-generated').textContent = new Date().toLocaleString('pt-BR');
        }

        function changeMonth(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            currentDate.setDate(1);
            updateMonthDisplay();
            renderUI();
        }

        function setSystemMode(mode, shouldRender = true) {
            currentMode = mode;
            document.getElementById('btn-mode-schedule').className = mode === 'schedule' ? "px-5 py-2 rounded-lg text-xs font-bold transition-all shadow-sm bg-white text-indigo-700 ring-1 ring-slate-200" : "px-5 py-2 rounded-lg text-xs font-bold text-slate-400 hover:text-slate-600 transition-all";
            document.getElementById('btn-mode-attendance').className = mode === 'attendance' ? "px-5 py-2 rounded-lg text-xs font-bold transition-all shadow-sm bg-white text-indigo-700 ring-1 ring-slate-200" : "px-5 py-2 rounded-lg text-xs font-bold text-slate-400 hover:text-slate-600 transition-all";
            
            const entityLabel = mode === 'schedule' ? 'Equipe' : 'Alunos';
            document.getElementById('sidebar-label').innerText = entityLabel;
            
            const title = mode === 'schedule' ? "Escala Mensal" : "Registro de Presença";
            document.getElementById('print-header-title').innerText = title;

            document.getElementById('schedule-controls').classList.toggle('hidden', mode === 'attendance');
            
            if (shouldRender) {
                renderMatrix();
                saveData();
            }
        }

        function handleGenerateTrigger() {
            if (employees.length === 0) return showToast("Adicione colaboradores primeiro", "error");
            
            const list = document.getElementById('dates-checkbox-list');
            list.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysNames = ["D", "S", "T", "Q", "Q", "S", "S"];

            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month, d);
                const dw = date.getDay();
                const isWE = dw === 0 || dw === 6;
                const iso = date.toISOString().split('T')[0];
                const checked = selectedDays.includes(d) ? 'checked' : (isWE ? '' : 'checked');
                
                list.innerHTML += `
                    <label class="flex items-center gap-4 p-4 bg-white border border-slate-100 rounded-2xl cursor-pointer hover:border-indigo-200 transition-colors shadow-sm">
                        <input type="checkbox" name="sel-day" value="${d}" ${checked} class="w-5 h-5 rounded-md text-indigo-600 focus:ring-indigo-500 border-slate-300">
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-slate-700">Dia ${d.toString().padStart(2, '0')} <span class="text-slate-400 font-normal">• ${daysNames[dw]}</span></span>
                            ${holidays[iso] ? `<span class="text-[10px] text-rose-500 font-bold uppercase mt-0.5">${holidays[iso]}</span>` : ''}
                        </div>
                    </label>
                `;
            }
            openModal('date-selection-modal');
        }

        function toggleAllDatesSelection() {
            const checks = document.querySelectorAll('input[name="sel-day"]');
            const all = Array.from(checks).every(c => c.checked);
            checks.forEach(c => c.checked = !all);
        }

        function confirmGenerateWithDates() {
            const checkboxes = document.querySelectorAll('input[name="sel-day"]:checked');
            selectedDays = Array.from(checkboxes).map(c => parseInt(c.value));
            
            if(selectedDays.length === 0) return showToast("Selecione pelo menos um dia.", "error");

            generateSchedule();
            closeModal('date-selection-modal');
        }

        function generateSchedule() {
            globalHODays = parseInt(document.getElementById('global-ho-days').value) || 2;
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            schedule = {};
            const shuffled = [...employees].sort(() => Math.random() - 0.5);
            const empPatterns = {};
            shuffled.forEach((emp, idx) => { 
                empPatterns[emp.id] = generatePatternForDays(globalHODays, idx);
            });

            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}-${month}-${d}`;
                const dateObj = new Date(year, month, d);
                const iso = dateObj.toISOString().split('T')[0];
                const dayWeek = dateObj.getDay();

                if (!selectedDays.includes(d)) continue; 

                const isHoliday = holidays[iso] && (holidays[iso] === 'FERIADO' || holidays[iso] === 'FACULTATIVO');
                const isWeekend = dayWeek === 0 || dayWeek === 6;

                if (!isWeekend && !isHoliday) {
                    schedule[dateKey] = [];
                    const workIdx = dayWeek - 1; 
                    shuffled.forEach(emp => {
                        if (isEmployeeOnVacation(emp.id, dateObj)) return;
                        if (empPatterns[emp.id].includes(workIdx)) schedule[dateKey].push(emp.id);
                    });
                }
            }
            isScheduleGenerated = true;
            saveData();
            renderUI();
            showToast("Escala gerada com sucesso!");
        }

        function generatePatternForDays(count, index) {
            if (count <= 0) return [];
            if (count >= 5) return [0,1,2,3,4];
            if (count === 2) return hoPairs[index % hoPairs.length];
            const week = [0,1,2,3,4];
            const res = [];
            for(let i=0; i<count; i++) res.push(week[(index + i) % 5]);
            return res.sort();
        }

        function dragStart(ev, dateKey, empId) {
            if(currentMode === 'attendance') return ev.preventDefault();
            ev.dataTransfer.setData("text/plain", JSON.stringify({sourceDate: dateKey, empId: empId}));
        }
        function allowDrop(ev) {
            if(currentMode === 'attendance') return;
            ev.preventDefault();
            const cell = ev.target.closest('td');
            if(cell) cell.classList.add('drag-target-active');
        }
        function dragLeave(ev) {
            const cell = ev.target.closest('td');
            if(cell) cell.classList.remove('drag-target-active');
        }
        function drop(ev, targetDateKey, targetEmpId) {
            if(currentMode === 'attendance') return;
            ev.preventDefault();
            const cell = ev.target.closest('td');
            if(cell) cell.classList.remove('drag-target-active');
            try {
                const data = JSON.parse(ev.dataTransfer.getData("text/plain"));
                const {sourceDate, empId} = data;
                if (sourceDate === targetDateKey && empId === targetEmpId) return;
                if (schedule[sourceDate]) {
                    const idx = schedule[sourceDate].indexOf(empId);
                    if (idx > -1) schedule[sourceDate].splice(idx, 1);
                }
                if (!schedule[targetDateKey]) schedule[targetDateKey] = [];
                if (!schedule[targetDateKey].includes(targetEmpId)) schedule[targetDateKey].push(targetEmpId);
                saveData(); renderMatrix();
            } catch (err) { console.error(err); }
        }

        function renderMatrix() {
            const head = document.getElementById('matrix-head');
            const body = document.getElementById('matrix-body');
            head.innerHTML = ''; body.innerHTML = '';
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const nameColLabel = currentMode === 'schedule' ? 'COLABORADOR' : 'NOME';

            let headerRow = `<tr class="h-14"><th class="sticky-corner px-4 py-3 min-w-[220px] border-b text-left bg-white z-50 shadow-[4px_0_10px_-4px_rgba(0,0,0,0.1)] text-slate-800 font-extrabold">${nameColLabel}</th>`;
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month, d);
                const dw = date.getDay();
                const letter = ["D","S","T","Q","Q","S","S"][dw];
                const iso = date.toISOString().split('T')[0];
                const isActive = selectedDays.includes(d);
                const hol = holidays[iso];
                
                let bg = isActive ? (dw === 0 || dw === 6 ? 'bg-slate-50' : 'bg-white') : 'bg-slate-100 opacity-40';
                let txt = isActive ? 'text-slate-600' : 'text-slate-400';
                if(hol) { bg = 'bg-rose-50'; txt = 'text-rose-600'; }

                headerRow += `<th class="sticky-header border-b border-r border-slate-100 text-center min-w-[36px] ${bg} ${txt}">
                    <div class="flex flex-col items-center justify-center h-full">
                        <span class="text-[9px] opacity-70 font-semibold">${letter}</span>
                        <span class="text-sm font-bold">${d}</span>
                    </div>
                </th>`;
            }
            headerRow += `<th class="sticky-header px-2 border-b bg-indigo-50 text-indigo-700 text-center font-black min-w-[50px]">TOT</th></tr>`;
            head.innerHTML = headerRow;

            employees.forEach(emp => {
                let rowHtml = `<tr class="group hover:bg-slate-50/80 transition-colors"><td class="sticky-col px-4 py-2.5 text-xs font-bold border-b border-r border-slate-100 text-slate-700 bg-white group-hover:bg-slate-50 transition-colors truncate max-w-[200px] shadow-[4px_0_10px_-4px_rgba(0,0,0,0.05)]">${emp.name}</td>`;
                let total = 0;

                for (let d = 1; d <= daysInMonth; d++) {
                    const dateKey = `${year}-${month}-${d}`;
                    const dateObj = new Date(year, month, d);
                    const iso = dateObj.toISOString().split('T')[0];
                    const isActive = selectedDays.includes(d);
                    const hol = holidays[iso];
                    const onVac = isEmployeeOnVacation(emp.id, dateObj);
                    const isHO = schedule[dateKey]?.includes(emp.id);
                    const att = attendance[`${dateKey}-${emp.id}`];

                    let cellClass = "border-b border-r border-slate-100 text-center h-10 transition-all text-[10px] select-none ";
                    let content = "";
                    let click = "";
                    let dragAction = "";

                    if (!isActive) {
                        cellClass += "bg-slate-50 opacity-20 cursor-not-allowed";
                    } else if (onVac) {
                        cellClass += "bg-amber-100 text-amber-700 font-bold";
                        content = `<i data-lucide="plane" class="w-3.5 h-3.5 mx-auto"></i>`;
                    } else if (hol) {
                        cellClass += "bg-rose-50 text-rose-500 font-black";
                        content = "F";
                    } else if (currentMode === 'schedule') {
                        if (isHO) {
                            cellClass += "bg-slate-50 text-slate-400 font-bold draggable-source hover:bg-indigo-50 hover:text-indigo-400";
                            content = "HO";
                            dragAction = `draggable="true" ondragstart="dragStart(event, '${dateKey}', ${emp.id})"`;
                        } else {
                            cellClass += "bg-white text-indigo-600 font-black draggable-source hover:bg-indigo-50";
                            content = "EP";
                            total++;
                        }
                        click = `onclick="toggleCell('${dateKey}', ${emp.id})"`;
                        dragAction += ` ondragover="allowDrop(event)" ondragleave="dragLeave(event)" ondrop="drop(event, '${dateKey}', ${emp.id})"`;
                    } else {
                        const s = att?.status || 'P';
                        cellClass += `status-${s} cursor-pointer font-black hover:opacity-80`;
                        content = s;
                        if(['P','A','S'].includes(s)) total++;
                        click = `onclick="openAttendanceModal('${dateKey}', ${emp.id}, '${emp.name}')"`;
                    }

                    rowHtml += `<td class="${cellClass}" ${click} ${dragAction}>${content}</td>`;
                }
                rowHtml += `<td class="bg-indigo-50/30 text-center text-xs font-black text-indigo-700 border-b border-indigo-100">${total}</td></tr>`;
                body.innerHTML += rowHtml;
            });
            lucide.createIcons();
        }

        function openAttendanceModal(key, id, name) {
            currentAttKey = `${key}-${id}`;
            const att = attendance[currentAttKey] || {};
            
            document.getElementById('att-modal-title').innerText = name;
            document.getElementById('att-modal-subtitle').innerText = key.split('-').reverse().join('/');
            
            document.getElementById('att-subject').value = att.subject || "";
            document.getElementById('att-time-start').value = att.timeStart || "";
            document.getElementById('att-time-end').value = att.timeEnd || "";
            document.getElementById('att-obs').value = att.obs || "";
            
            const radios = document.getElementsByName('att-status');
            radios.forEach(r => r.checked = r.value === (att.status || 'P'));
            
            toggleJustification(att.status === 'J');
            openModal('attendance-modal');
        }

        function toggleJustification(show) { document.getElementById('justification-fields').classList.toggle('hidden', !show); }

        function saveAttendance() {
            const status = document.querySelector('input[name="att-status"]:checked').value;
            const obs = document.getElementById('att-obs').value;
            if(status === 'J' && !obs) return showToast("Observação obrigatória para justificativa.", "error");

            attendance[currentAttKey] = {
                status,
                subject: document.getElementById('att-subject').value,
                timeStart: document.getElementById('att-time-start').value,
                timeEnd: document.getElementById('att-time-end').value,
                obs: obs
            };
            saveData(); renderMatrix(); closeModal('attendance-modal');
            showToast("Registro salvo");
        }

        function handleFileUpload(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(e.target.result, {type:'binary'});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(ws);
                
                employees = jsonData.map((row, idx) => {
                    const name = row.Nome || row.nome || row.COLABORADOR || row.Colaborador;
                    if(!name) return null;
                    return { id: Date.now() + idx, name: name.toString().trim() };
                }).filter(e => e !== null);

                saveData(); renderUI();
                showToast(`${employees.length} registros importados.`);
                setTimeout(handleGenerateTrigger, 500);
            };
            reader.readAsBinaryString(file);
            input.value = '';
        }

        function openReportsModal() {
            const tbody = document.getElementById('reports-body');
            tbody.innerHTML = '';
            let grandP = 0, grandF = 0, grandJ = 0, grandPossible = 0;
            
            const chartLabels = [];
            const chartDataP = [];
            const chartDataF = [];
            const chartDataJ = [];

            employees.forEach(emp => {
                let p = 0, f = 0, j = 0, count = 0;
                selectedDays.forEach(d => {
                    const key = `${currentDate.getFullYear()}-${currentDate.getMonth()}-${d}`;
                    const att = attendance[key + '-' + emp.id]?.status || 'P';
                    if(['P','A','S'].includes(att)) p++; else if(att === 'F') f++; else if(att === 'J') j++;
                    count++;
                });
                grandP += p; grandF += f; grandJ += j; grandPossible += count;
                const freq = count > 0 ? Math.round((p/count)*100) : 0;
                const color = freq >= 90 ? 'text-emerald-600' : (freq >= 70 ? 'text-amber-600' : 'text-rose-600');
                
                tbody.innerHTML += `<tr><td class="p-4 font-bold text-slate-700">${emp.name}</td><td class="p-4 text-center text-emerald-600 font-bold bg-emerald-50/30 rounded-lg">${p}</td><td class="p-4 text-center text-rose-600 font-bold bg-rose-50/30 rounded-lg">${f}</td><td class="p-4 text-center text-blue-600 font-bold bg-blue-50/30 rounded-lg">${j}</td><td class="p-4"><div class="flex items-center gap-3"><span class="text-xs font-black ${color} w-8">${freq}%</span><div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full ${freq >= 70 ? 'bg-emerald-500' : 'bg-rose-500'}" style="width: ${freq}%"></div></div></div></td></tr>`;
                
                chartLabels.push(emp.name);
                chartDataP.push(p);
                chartDataF.push(f);
                chartDataJ.push(j);
            });

            document.getElementById('rep-total-presencas').innerText = grandP;
            document.getElementById('rep-total-faltas').innerText = grandF;
            document.getElementById('rep-total-just').innerText = grandJ;
            document.getElementById('rep-freq-geral').innerText = grandPossible > 0 ? Math.round((grandP/grandPossible)*100) + '%' : '0%';
            
            renderChart(chartLabels, chartDataP, chartDataF, chartDataJ);
            openModal('reports-modal');
        }

        function renderChart(labels, dataP, dataF, dataJ) {
            const ctx = document.getElementById('attendance-chart').getContext('2d');
            if (attendanceChart) attendanceChart.destroy();

            attendanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Presenças', data: dataP, backgroundColor: '#10b981', borderRadius: 4, barThickness: 10 },
                        { label: 'Faltas', data: dataF, backgroundColor: '#f43f5e', borderRadius: 4, barThickness: 10 },
                        { label: 'Justificadas', data: dataJ, backgroundColor: '#3b82f6', borderRadius: 4, barThickness: 10 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: { stacked: true, beginAtZero: true, grid: { color: '#f1f5f9' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function downloadPortalFile() {
            const data = { employees, schedule, attendance, holidays, context, year: currentDate.getFullYear(), month: currentDate.getMonth(), monthName: currentDate.toLocaleDateString('pt-BR', {month:'long'}), selectedDays };
            
            // --- PORTAL PREMIUM APP TEMPLATE ---
            const portalHTML = `<!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Portal do Colaborador</title><script src="https://cdn.tailwindcss.com"></`+`script><script src="https://unpkg.com/lucide@latest"></`+`script><link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet"><style>body{font-family:'Plus Jakarta Sans',sans-serif;background:#f8fafc}.card{background:white;border-radius:16px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.05),0 2px 4px -1px rgba(0,0,0,0.01)}.status-ho{background:#f1f5f9;color:#64748b;font-weight:700}.status-ep{background:#eff6ff;color:#4f46e5;font-weight:800}.status-badge{padding:4px 12px;border-radius:99px;font-size:11px;text-transform:uppercase;letter-spacing:0.05em}.animate-slide-up{animation:slideUp 0.4s ease-out forwards;opacity:0;transform:translateY(20px)}@keyframes slideUp{to{opacity:1;transform:translateY(0)}}</style></head><body class="min-h-screen p-4 md:p-8"><div class="max-w-md mx-auto"><div class="text-center mb-8"><div class="inline-flex items-center justify-center w-12 h-12 bg-indigo-600 rounded-xl shadow-lg shadow-indigo-200 mb-4"><i data-lucide="layers" class="text-white w-6 h-6"></i></div><h1 class="text-2xl font-extrabold text-slate-900 tracking-tight">Portal do Colaborador</h1><p class="text-slate-500 font-medium text-sm mt-1 uppercase tracking-wider">\${DATA.monthName} \${DATA.year}</p></div><div class="card p-2 mb-6 shadow-xl shadow-slate-200/50"><div class="relative"><i data-lucide="search" class="absolute left-4 top-3.5 text-slate-400 w-5 h-5"></i><input type="text" id="n" placeholder="Digite seu nome..." class="w-full pl-12 pr-4 py-3 rounded-xl bg-slate-50 border-none outline-none focus:ring-2 focus:ring-indigo-500 font-semibold text-slate-700 transition-all placeholder:text-slate-400" onkeyup="if(event.key==='Enter')s()"></div><button onclick="s()" class="w-full mt-2 bg-slate-900 text-white font-bold py-3.5 rounded-xl hover:bg-indigo-600 transition-colors shadow-lg">CONSULTAR ESCALA</button></div><div id="r" class="space-y-4"></div></div><script>const DATA=${JSON.stringify(data)};function s(){const v=document.getElementById('n').value.toLowerCase().trim();if(v.length<3){alert('Digite pelo menos 3 letras');return}const e=DATA.employees.find(x=>x.name.toLowerCase().includes(v));const r=document.getElementById('r');r.innerHTML='';if(!e){r.innerHTML='<div class="text-center p-8 bg-white rounded-2xl border border-slate-100 shadow-sm"><div class="text-rose-500 font-bold mb-2">Não encontrado</div><p class="text-slate-400 text-sm">Verifique se digitou o nome corretamente.</p></div>';lucide.createIcons();return}let daysHTML='';let hoCount=0,epCount=0;DATA.selectedDays.forEach(d=>{const k=\`\${DATA.year}-\${DATA.month}-\${d}\`;const isH=DATA.schedule[k]&&DATA.schedule[k].includes(e.id);if(isH)hoCount++;else epCount++;const date=new Date(DATA.year,DATA.month,d);const dw=['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'][date.getDay()];daysHTML+=\`<div class="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-2xl mb-3 shadow-sm hover:shadow-md transition-shadow animate-slide-up"><div class="flex items-center gap-4"><div class="flex flex-col items-center justify-center bg-slate-50 w-12 h-12 rounded-xl border border-slate-100"><span class="text-[10px] uppercase font-bold text-slate-400">\${dw}</span><span class="text-lg font-black text-slate-700">\${d}</span></div><div class="flex flex-col"><span class="text-sm font-bold text-slate-600">\${isH?'Home Office':'Presencial'}</span><span class="text-[10px] text-slate-400 font-medium">\${isH?'Trabalho remoto':'Escritório Central'}</span></div></div><span class="status-badge \${isH?'status-ho':'status-ep'}">\${isH?'HO':'EP'}</span></div>\`});const summary=\`<div class="bg-indigo-600 p-6 rounded-3xl shadow-xl shadow-indigo-200 mb-6 text-white animate-slide-up"><h2 class="text-xl font-bold mb-1">\${e.name}</h2><p class="text-indigo-200 text-xs font-bold uppercase tracking-widest mb-6">Resumo Mensal</p><div class="flex gap-4"><div class="bg-indigo-500/50 p-3 rounded-2xl flex-1 backdrop-blur-sm"><span class="block text-2xl font-black">\${epCount}</span><span class="text-[10px] uppercase font-bold text-indigo-200">Dias Presenciais</span></div><div class="bg-indigo-500/50 p-3 rounded-2xl flex-1 backdrop-blur-sm"><span class="block text-2xl font-black">\${hoCount}</span><span class="text-[10px] uppercase font-bold text-indigo-200">Dias Home Office</span></div></div></div>\`;r.innerHTML=summary+daysHTML;lucide.createIcons()}</`+`script></body></html>`;
            
            const blob = new Blob([portalHTML], {type:'text/html'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Portal_Matrix_${data.monthName}.html`; a.click();
        }

        function toggleCell(key, id) { if(!schedule[key]) schedule[key] = []; const i = schedule[key].indexOf(id); if(i > -1) schedule[key].splice(i, 1); else schedule[key].push(id); saveData(); renderMatrix(); }
        function isEmployeeOnVacation(empId, date) { const v = vacations[empId] || []; const t = date.getTime(); return v.some(x => t >= new Date(x.start+'T00:00:00').getTime() && t <= new Date(x.end+'T00:00:00').getTime()); }
        function addEmployee() { const n = document.getElementById('new-emp-name').value.trim(); if(!n) return; employees.push({id:Date.now(), name:n}); document.getElementById('new-emp-name').value=''; saveData(); renderUI(); }
        function removeEmployee(id) { employees = employees.filter(e => e.id !== id); saveData(); renderUI(); }
        function handleClearEmployees() { employees = []; isScheduleGenerated = false; saveData(); renderUI(); }
        function handleReset() { if(confirm("Tem certeza? Isso apagará todos os dados.")) { localStorage.clear(); location.reload(); } }
        function saveContext() { context.local=document.getElementById('ctx-local').value; context.unidade=document.getElementById('ctx-unidade').value; context.sala=document.getElementById('ctx-sala').value; saveData(); renderContextUI(); closeModal('context-modal'); }
        function renderContextUI() { document.getElementById('header-local').innerText=context.local || "Gestão"; document.getElementById('header-unidade').innerText=context.unidade||"Inteligente"; document.getElementById('header-sep').className=context.local?'mx-1':'hidden'; document.getElementById('print-context').innerHTML=`<span>LOCAL: ${context.local||'-'}</span> <span>UNIDADE: ${context.unidade||'-'}</span> <span>SALA: ${context.sala||'-'}</span>`; }
        
        function renderEmployeeList() {
            const query = document.getElementById('emp-search').value.toLowerCase();
            const l = document.getElementById('employee-list'); 
            l.innerHTML = ''; 
            const filtered = employees.filter(e => e.name.toLowerCase().includes(query));
            document.getElementById('emp-count').innerText = employees.length; 
            filtered.forEach(e => { 
                l.innerHTML += `<div class="p-3 bg-white border border-slate-200 rounded-xl text-xs font-bold shadow-sm flex justify-between items-center group transition-all hover:border-indigo-300 hover:shadow-md mb-2"><span class="truncate pr-2 text-slate-600">${e.name}</span><button onclick="removeEmployee(${e.id})" class="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-rose-500 transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`; 
            }); 
            lucide.createIcons(); 
        }

        function renderUI() { renderEmployeeList(); renderContextUI(); if(employees.length > 0) { document.getElementById('empty-state').classList.add('hidden'); document.getElementById('matrix-container').classList.remove('hidden'); renderMatrix(); document.getElementById('btn-portal').disabled = !isScheduleGenerated; } else { document.getElementById('empty-state').classList.remove('hidden'); document.getElementById('matrix-container').classList.add('hidden'); } updateDashboard(); }
        function openContextModal() { document.getElementById('ctx-local').value = context.local || ""; document.getElementById('ctx-unidade').value = context.unidade || ""; document.getElementById('ctx-sala').value = context.sala || ""; openModal('context-modal'); }
        function openVacationModal() { const s = document.getElementById('vacation-emp-select'); s.innerHTML = '<option value="">Selecione...</option>'; employees.forEach(e => s.innerHTML += `<option value="${e.id}">${e.name}</option>`); renderVacationList(); openModal('vacation-modal'); }
        function openHolidayModal() { renderHolidayList(); openModal('holiday-modal'); }
        function downloadTemplate() { const ws = XLSX.utils.json_to_sheet([{"Nome":"João Silva"},{"Nome":"Maria Souza"}]); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Modelo"); XLSX.writeFile(wb, "modelo_escala.xlsx"); }
        function exportToExcel() { if(!isScheduleGenerated) return showToast("Gere a escala primeiro", "error"); const ws = XLSX.utils.json_to_sheet(employees.map(e => ({ "Colaborador": e.name }))); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Escala"); XLSX.writeFile(wb, "Escala.xlsx"); }
        
        function addVacation() { const empId = document.getElementById('vacation-emp-select').value; const start = document.getElementById('vacation-start').value; const end = document.getElementById('vacation-end').value; if(!empId || !start || !end) return; if(!vacations[empId]) vacations[empId] = []; vacations[empId].push({start, end}); saveData(); renderVacationList(); }
        function renderVacationList() { const list = document.getElementById('vacation-list'); list.innerHTML = ''; Object.keys(vacations).forEach(id => { const emp = employees.find(e => e.id == id); if(!emp) return; vacations[id].forEach((v, i) => { list.innerHTML += `<div class="p-4 bg-white border border-slate-100 rounded-2xl mb-2 flex justify-between items-center text-xs shadow-sm"><div><span class="font-bold text-slate-700 block mb-1">${emp.name}</span><span class="text-slate-400">${v.start.split('-').reverse().join('/')} até ${v.end.split('-').reverse().join('/')}</span></div><button onclick="vacations[${id}].splice(${i},1); saveData(); renderVacationList();" class="text-rose-400 bg-rose-50 p-1.5 rounded-lg hover:bg-rose-100"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`; }); }); lucide.createIcons(); }
        function addHoliday() { const d = document.getElementById('holiday-date').value; const t = document.getElementById('holiday-type').value; if(!d) return; holidays[d] = t; saveData(); renderHolidayList(); }
        function renderHolidayList() { const list = document.getElementById('holiday-list'); list.innerHTML = ''; Object.keys(holidays).sort().forEach(d => { list.innerHTML += `<div class="p-4 bg-white border border-slate-100 rounded-2xl mb-2 flex justify-between items-center text-xs shadow-sm"><div><span class="font-bold text-slate-700 block mb-1">${d.split('-').reverse().join('/')}</span><span class="text-slate-400 uppercase font-bold text-[10px]">${holidays[d]}</span></div><button onclick="delete holidays['${d}']; saveData(); renderHolidayList();" class="text-rose-400 bg-rose-50 p-1.5 rounded-lg hover:bg-rose-100"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`; }); lucide.createIcons(); }

        document.addEventListener('DOMContentLoaded', () => { loadData(); updateMonthDisplay(); renderUI(); initTooltips(); });
    </script>
</body>
</html>